# PointsApi

[![Coverage Status](https://coveralls.io/repos/github/pablohildo/points_api/badge.svg?branch=main&t=im1q6x)](https://coveralls.io/github/pablohildo/points_api?branch=main)

PointsApi is a simple API with a single endpoint that fetches at most two users with a number of points greater than a random number that changes every one minute, and a timestamp of the last time someone interacted with this endpoint. All of this is controlled by a GenServer that keeps `{max_number, timestamp}` as its state.

## Running

To start the API

  * Clone this repository;
  * Enter its folder with `cd points_api`;

### Locally

To run this API locally you'll need:

```
Elixir >= 1.12.1
Erlang/OTP >= 24
PostgreSQL 14.0
```
Older versions may work correctly, but weren't tested.

  * Install dependencies with `mix deps.get`;
  * Create a secrets file 
     ```bash
     touch config/dev.secret.exs;
     echo "import Config
     config :points_api, PointsApi.Repo,
        username: \"postgres\",
        password: \"postgres\",
        database: \"points_api_dev\",
        hostname: \"localhost\",
        show_sensitive_data_on_connection_error: true,
        pool_size: 10" >> config/dev.secret.exs

     ```
  * Fill the fields on the file correctly based on your running database server;
  * Create and migrate your database with `mix ecto.setup` â€” this command will create the database, table, and seed it with a million users with zero points;
  * Start Phoenix endpoint with `mix phx.server` or inside IEx with `iex -S mix phx.server`

### Using Docker

```sh
docker-compose build
docker-compose run api mix ecto.setup
docker-compose up
```
This will also create your database, table and and seed it with a million users with zero points, while also startint Phoenix endpoint.


**In both cases, now you can visit [`localhost:4000`](http://localhost:4000) from your browser or HTTP Client.**

## Usage

[`localhost:4000`](http://localhost:4000) or `/` is the only endpoint, and it's return will probably look like that on the first access:

`GET localhost:4000`
```js
{"timestamp": null,"users":[]}
```

If it is your first time making a request, the timestamp will be `null` since it wasn't queried yet; if it is before the first minute, `users` will be an empty array because `max_number` is initialized as a random number between `0-100` and all users will probably have `points = 0`, unless this database has been used by this API before.

After one minute and the first access, the timestamp will represent the last time a request was made, `max_number` will have a new value, `users` will have their points randomized and the response will probably look like that:

`GET localhost:4000`
```js
{
  "timestamp":"2021-10-07T06:45:02.569715",
  "users":[
    {"id":87166,"points":94},
    {"id":323117,"points":94}
  ]
}
```
Although

## Tests

This API has 100% code coverage measured by [ExCoveralls](https://github.com/parroty/excoveralls) and posted by the CI to [coveralls](https://coveralls.io)
. Three files are manually excluded of this evaluation, as it's possible to see in `coveralls.json`:
```js
{
    "skip_files": [
        "lib/points_api_web.ex",
        "lib/points_api/application.ex",
        "lib/points_api_web/controllers/fallback_controller.ex"
    ]
}
```
All those three files are automatically generated by Phoenix and the uncovered lines are usually related to Elixir/Erlang or Phoenix features and internal workings, such as `__using__` macro and `config_change`.

## Continuous Integration

A GitHub Actions pipeline is defined on `.github/workflows/ci.yml` with the following steps, running on push:

- **Docker**: Builds and starts the Docker image
- **Format**: Checks formatting using `mix format`, fails if not formatted
- **Credo**: Uses [Credo](https://github.com/rrrene/credo), a static code analysis tool, to check code consistency, fails on any warning
- **Test**: Runs all tests and posts coverage info to Coveralls.
